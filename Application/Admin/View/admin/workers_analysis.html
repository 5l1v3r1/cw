<extend name="public/template" />
<block name="headerlink">
	<!-- BEGIN PAGE LEVEL STYLES -->
	<link rel="stylesheet" type="text/css" href="__PUBLIC__/metronic3_7/assets/global/plugins/select2/select2.css"/>
	<link rel="stylesheet" type="text/css" href="__PUBLIC__/metronic3_7/assets/global/plugins/datatables/plugins/bootstrap/dataTables.bootstrap.css"/>
	<link rel="stylesheet" type="text/css" href="__PUBLIC__/metronic3_7/assets/global/plugins/bootstrap-datepicker/css/datepicker.css"/>
	<!-- END PAGE LEVEL STYLES -->
  <style> /* CSS styling */

  .tooltip{
    background: #eee;
            box-shadow: 0 0 5px #999999;
            color: #333;
            font-size: 12px;
            padding: 10px;
            position: absolute;
            text-align: center;
            width: 120px;
            z-index: 10;
  }

</style>
	<script src="https://d3js.org/d3.v4.min.js"></script>
</block>
<block name="siderbarmenu">
	<ul class="page-sidebar-menu " data-keep-expanded="false" data-auto-scroll="true" data-slide-speed="200">
		<!-- DOC: To remove the sidebar toggler from the sidebar you just need to completely remove the below "sidebar-toggler-wrapper" LI element -->
		<li class="sidebar-toggler-wrapper">
			<!-- BEGIN SIDEBAR TOGGLER BUTTON -->
			<div class="sidebar-toggler">
			</div>
			<!-- END SIDEBAR TOGGLER BUTTON -->
		</li>
		<!-- DOC: To remove the search box from the sidebar you just need to completely remove the below "sidebar-search-wrapper" LI element -->
		<li class="sidebar-search-wrapper">
			<!-- BEGIN RESPONSIVE QUICK SEARCH FORM -->
			<!-- DOC: Apply "sidebar-search-bordered" class the below search form to have bordered search box -->
			<!-- DOC: Apply "sidebar-search-bordered sidebar-search-solid" class the below search form to have bordered & solid search box -->
			<form class="sidebar-search " action="extra_search.html" method="POST">
				<a href="javascript:;" class="remove">
				<i class="icon-close"></i>
				</a>
				<div class="input-group">
					<input type="text" class="form-control" placeholder="Search...">
					<span class="input-group-btn">
					<a href="javascript:;" class="btn submit"><i class="icon-magnifier"></i></a>
					</span>
				</div>
			</form>
			<!-- END RESPONSIVE QUICK SEARCH FORM -->
		</li>
		<li class="start">
			<a href="javascript:;">
			<i class="icon-home"></i>
			<span class="title">Dashboard</span>
			<span class="selected"></span>
			<span class="arrow open"></span>
			</a>
			<ul class="sub-menu">
				<li>
					<a href="{:U('Dashboard/index');}">
					<i class="icon-bar-chart"></i>
					Default Dashboard</a>
				</li>
				<li>
					<a href="{:U('Dashboard/showDataMoneyAnalysis');}">
					<i class="icon-bar-chart"></i>
					Data Analysis</a>
				</li>
			</ul>
		</li>
		<li>
			<a href="javascript:;">
			<i class="icon-basket"></i>
			<span class="title">eCommerce</span>
			<span class="arrow "></span>
			</a>
			<ul class="sub-menu">
				<li>
					<a href="{:U('Order/showDataAnalysisPage');}">
					<i class="icon-home"></i>
					Dashboard</a>
				</li>
				<li>
					<a href="{:U('Order/orderlist?flag=2');}">
					<i class="icon-bell"></i>
					<span class="badge badge-danger">{$cin}</span>
					Orders Ongoing</a>
				</li>
				<li>
					<a href="{:U('Order/orderlist?flag=4');}">
					<i class="fa fa-warning"></i>
					<span class="badge badge-danger">{$cin1}</span>
					<font color="red">Orders Warning</font></a>
				</li>
				<li>
					<a href="{:U('Order/orderlist?flag=1');}">
					<i class="fa fa-lock"></i>
					Complete Orders</a>
				</li>
				<li>
					<a href="{:U('Order/orderlist?flag=3');}">
					<i class="icon-basket"></i>
					Orders All</a>
				</li>
				<li>
					<a href="#">
						<i class="icon-bar-chart"></i>
						Data Analysis
					</a>
				</li>
			</ul>
		</li>
		<li class="active">
			<a href="javascript:;">
				<i class="fa fa-code"></i>
				<span class="title">Workers</span>
				<span class="arrow "></span>
			</a>
			<ul class="sub-menu">
				<li class="active">
					<a href="{:U('Worker/showDataAnalysisPage');}">
					<i class="icon-home"></i>
					Dashboard</a>
				</li>
				<li>
					<a href="{:U('Worker/workerRecommandPage');}">
						<i class="fa fa-smile-o" aria-hidden="true"></i>
						Workers Recommand
					</a>
				</li>
				<li class="active">
					<a href="{:U('Worker/workerlist');}">
						<i class="fa fa-list" aria-hidden="true"></i>
						ALL Workers Workers
					</a>
				</li>
				<li>
					<a href="{:U('Worker/workerlist?type=4');}">
						<i class="fa fa-user-circle-o" aria-hidden="true"></i>
						free workers
					</a>
				</li>
				<li>
					<a href="{:U('Worker/workerlist?type=5');}">
						<i class="fa fa-user-circle-o" aria-hidden="true"></i>
						busy workers
					</a>
				</li>
				<li>
					<a href="{:U('Worker/workerlist?type=2');}">
						<i class="fa fa-user-circle-o" aria-hidden="true"></i>
						Income > 0
					</a>
				</li>
				<li >
					<a href="{:U('Worker/workerlist?type=1');}">
						<i class="fa fa-user-circle-o" aria-hidden="true"></i>
						Income = 0
					</a>
				</li>
				<li>
					<a href="{:U('Worker/workerlist?type=3');}">
						<i class="fa fa-user-times" aria-hidden="true"></i>
						dead workers
					</a>
				</li>
				<li>
					<a href="#">
						<i class="icon-bar-chart"></i>
						Data Analysis
					</a>
				</li>
			</ul>
		</li>
		<li>
			<a href="javascript:;">
			<i class="fa fa-wrench" aria-hidden="true"></i>
			<span class="title">Tools</span>
			<span class="arrow "></span>
			</a>
			<ul class="sub-menu">
				<li>
					<a href="{:U('Tool/exchangeToolPage');}">
						<i class="fa fa-exchange" aria-hidden="true"></i> Transfer Tools
					</a>
				</li>
			</ul>
		</li>
		<li>
			<a href="javascript:;">
			<i class="icon-settings"></i>
			<span class="title">Configuration</span>
			<span class="arrow "></span>
			</a>
			<ul class="sub-menu">
				<li>
					<a href="{:U('Configure/exchangelist');}">
						<i class="fa fa-line-chart" aria-hidden="true"></i>
						Exchange Rate
					</a>
				</li>
				<li>
					<a href="{:U('Configure/techlist');}">
						<i class="fa fa-microchip" aria-hidden="true"></i>
						Technologies Conf
					</a>
				</li>
				<li>
					<a href="{:U('Configure/tradelist');}">
						<i class="fa fa-info-circle" aria-hidden="true"></i>
						Trade Conf
					</a>
				</li>
				<li>
					<a href="{:U('Configure/shortcutlistpage');}">
						<i class="fa fa-sliders" aria-hidden="true"></i>
						Shortcut Conf
					</a>
				</li>
				<li>
					<a href="{:U('Configure/tipslist');}">
						<i class="fa fa-calendar-check-o" aria-hidden="true"></i>
						Tips Conf
					</a>
				</li>

			</ul>
		</li>
	</ul>
</block>
<block name="container">
	<div class="page-content">
			<!-- BEGIN SAMPLE PORTLET CONFIGURATION MODAL FORM-->
			<!-- END SAMPLE PORTLET CONFIGURATION MODAL FORM-->
			<!-- BEGIN STYLE CUSTOMIZER -->
			<!-- END STYLE CUSTOMIZER -->
			<!-- BEGIN PAGE HEADER-->
			<div class="page-bar">
				<ul class="page-breadcrumb">
					<li>
						<i class="fa fa-home"></i>
						<a href="{:U('Dashboard/index');}">Home</a>
						<i class="fa fa-angle-right"></i>
					</li>
					<li>
						<a href="#">Dashboard</a>
					</li>
				</ul>
			</div>
			<h3 class="page-title">
			Workers Dashboard <small>reports & statistics</small>
			</h3>
			<!-- END PAGE HEADER-->
			<!-- BEGIN DASHBOARD STATS -->
			<div class="row">
				<div class="col-lg-3 col-md-3 col-sm-6 col-xs-12">
					<div class="dashboard-stat blue-madison">
						<div class="visual">
							<i class="fa fa-comments"></i>
						</div>
						<div class="details">
							<div class="number">
								 {$workertotal.worker_total} <i class="fa fa-cny"></i>
							</div>
							<div class="desc">
								 Total No.
							</div>
						</div>
						<a class="more" href="javascript:;">
						View more <i class="m-icon-swapright m-icon-white"></i>
						</a>
					</div>
				</div>
				<div class="col-lg-3 col-md-3 col-sm-6 col-xs-12">
					<div class="dashboard-stat red-intense">
						<div class="visual">
							<i class="fa fa-bar-chart-o"></i>
						</div>
						<div class="details">
							<div class="number">
								 {$workertotal.worker_doing} <i class="fa fa-cny"></i>
							</div>
							<div class="desc">
								 Busy No.
							</div>
						</div>
						<a class="more" href="javascript:;">
						View more <i class="m-icon-swapright m-icon-white"></i>
						</a>
					</div>
				</div>
				<div class="col-lg-3 col-md-3 col-sm-6 col-xs-12">
					<div class="dashboard-stat green-haze">
						<div class="visual">
							<i class="fa fa-shopping-cart"></i>
						</div>
						<div class="details">
							<div class="number">
								 {$workertotal.worker_unpaidsalary} <i class="fa fa-cny"></i>
							</div>
							<div class="desc">
								 Unpaid
							</div>
						</div>
						<a class="more" href="javascript:;">
						View more <i class="m-icon-swapright m-icon-white"></i>
						</a>
					</div>
				</div>
				<div class="col-lg-3 col-md-3 col-sm-6 col-xs-12">
					<div class="dashboard-stat purple-plum">
						<div class="visual">
							<i class="fa fa-globe"></i>
						</div>
						<div class="details">
							<div class="number">
								 {$workertotal.worker_unpaid} <i class="fa fa-cny"></i>
							</div>
							<div class="desc">
								 Unpaid No.
							</div>
						</div>
						<a class="more" href="javascript:;">
						View more <i class="m-icon-swapright m-icon-white"></i>
						</a>
					</div>
				</div>
			</div>
			<!-- END DASHBOARD STATS -->
			<div class="clearfix"></div>
			<div class="row">
				<div class="col-md-12 col-sm-12">
				<!-- BEGIN PORTLET-->
					<div class="portlet light ">
						<div class="portlet-title">
							<div class="caption">
								<i class="icon-bar-chart font-green-sharp hide"></i>
								<span class="caption-subject font-green-sharp bold uppercase">Global statistic</span>
								<span class="caption-helper">global statistic...</span>
							</div>
						</div>
						<div class="portlet-body">
							<div class="portlet-body">
								<div class="col-md-4 col-sm-3">
									<h4><i class="fa fa-bar-chart-o"></i> Total Datas analysis</h4>
									<div class="row static-info ">
										<div class="col-md-6 name">
											 Total No. :
										</div>
										<div class="col-md-6 value">
											 <i class="fa fa-paper-plane"></i> {$workertotal.worker_total}
										</div>
									</div>
									<div class="row static-info">
										<div class="col-md-6 name">
											 Busy No. :
										</div>
										<div class="col-md-6 value">
											 <i class="fa fa-paper-plane"></i> {$workertotal.worker_doing}
										</div>
									</div>
									<div class="row static-info">
										<div class="col-md-6 name">
											 Free No. :
										</div>
										<div class="col-md-6 value">
											 <i class="fa fa-paper-plane"></i> {$workertotal.worker_free}
										</div>
									</div>
									<div class="row static-info">
										<div class="col-md-6 name">
											 All Salary :
										</div>
										<div class="col-md-6 value">
											 <i class="fa fa-paper-plane"></i> {$workertotal.worker_salary} <i class='fa fa-rmb'></i>
										</div>
									</div>
									<div class="row static-info">
										<div class="col-md-6 name">
											 Unpaid Salary :
										</div>
										<div class="col-md-6 value">
											 <i class="fa fa-paper-plane"></i> {$workertotal.worker_unpaidsalary} <i class='fa fa-rmb'></i>
										</div>
									</div>
									<div class="clearfix"></div>


								</div>
								<div class="col-md-3 col-sm-12">
									<h4><i class="fa fa-bar-chart-o"></i> Worker Status analysis</h4>
									<div id="totalpiechart" style="padding: 0px;width:100%;height:200px;"></div>
								</div>
								<div class="clearfix"></div>
							</div>
						</div>
					</div>
				<!-- END PORTLET-->
			</div>


				<!-- END PORTLET-->

				<!-- END PORTLET-->
				<div class="col-md-6 col-sm-6">
						<div class="portlet box red">
							<div class="portlet-title">
								<div class="caption">
									<i class="fa fa-bar-chart-o"></i> Worker Status Number statistic
								</div>
								<div class="tools">
									<a href="javascript:;" class="collapse" data-original-title="" title="">
									</a>
									<a href="#portlet-config" data-toggle="modal" class="config" data-original-title="" title="">
									</a>
									<a href="javascript:;" class="reload" data-original-title="" title="">
									</a>
									<a href="javascript:;" class="remove" data-original-title="" title="">
									</a>
								</div>
							</div>
							<div class="portlet-body form">
								<div class="row">

									<div id='stackedbar' class="chart" style="padding: 0px;width:100%;height: 1080px;"></div>

								</div>

							</div>
						</div>
				</div>
				<div class="col-md-6 col-sm-6">
						<div class="portlet box green">
							<div class="portlet-title">
								<div class="caption">
									<i class="fa fa-bar-chart-o"></i> Worker Status Rate statistic
								</div>
								<div class="tools">
									<a href="javascript:;" class="collapse" data-original-title="" title="">
									</a>
									<a href="#portlet-config" data-toggle="modal" class="config" data-original-title="" title="">
									</a>
									<a href="javascript:;" class="reload" data-original-title="" title="">
									</a>
									<a href="javascript:;" class="remove" data-original-title="" title="">
									</a>
								</div><i class='fa fa-rmb'></i>
							</div>
							<div class="portlet-body form">
								<div class="row">

									<div id='horizonbar' class="chart" style="padding: 0px;width:100%;height: 1080px;"></div>

								</div>

							</div>
						</div>
				</div>



			</div>
			<div class="clearfix">
			</div>
		</div>
</block>
<block name="footscript">
	<!-- BEGIN PAGE LEVEL PLUGINS -->
	<script type="text/javascript" src="__PUBLIC__/metronic3_7/assets/global/plugins/select2/select2.min.js"></script>
	<script type="text/javascript" src="__PUBLIC__/metronic3_7/assets/global/plugins/datatables/media/js/jquery.dataTables.min.js"></script>
	<script type="text/javascript" src="__PUBLIC__/metronic3_7/assets/global/plugins/datatables/plugins/bootstrap/dataTables.bootstrap.js"></script>
	<script type="text/javascript" src="__PUBLIC__/metronic3_7/assets/global/plugins/bootstrap-datepicker/js/bootstrap-datepicker.js"></script>
	<!-- END PAGE LEVEL PLUGINS -->
	<!-- BEGIN PAGE LEVEL SCRIPTS -->
	<script src="__PUBLIC__/metronic3_7/assets/global/scripts/metronic.js" type="text/javascript"></script>
	<script src="__PUBLIC__/metronic3_7/assets/admin/layout/scripts/layout.js" type="text/javascript"></script>

	<!-- END PAGE LEVEL SCRIPTS -->
	<script>
			jQuery(document).ready(function() {
           Metronic.init(); // init metronic core components
Layout.init(); // init current layout
			});
		get_workertech_query();
		function get_workertech_query(){
			var data = {};
			var url='__URL__/getTechWorkerDatas';
			$.ajax({
				type:"get",
				url:url,
				success: function aa(data) {
					//showstorelist(data.stores);
					console.log(data);
					//var para = {mindate:fstep ,maxdate:tstep,xtformate:xtformate,xnum:xnum,ytext:"Total Profit"};
					//drawLineChart(data,"#chart","profit",para);
					drwaStackBar(data,"#stackedbar",["free","doing","unpaid"]);

				}
			});
		}

		//drwaStackBar(data,chartid,keys);
		function drwaStackBar(data,chartid,keys){
			$(chartid).html("");
			var wd = $(chartid).width();
			var wh = $(chartid).height();
			var margin = {top:10, left:120, bottom:50, right:20};
			var height = wh - margin.top - margin.bottom,
				width = wd - margin.left - margin.right;
			var svg = d3.select(chartid).append("svg")
						  .attr("width", (width + margin.left + margin.right)+"px")
						  .attr("height", (height+margin.top + margin.bottom)+"px")
						  .append('g')
						  .attr("transform", `translate(${margin.left}, ${margin.right})`);
			var tooltip = d3.select('#stackedbar').append('div')
				.attr('class', 'tooltip').style('opacity', 0);


			var y = d3.scaleBand()			// x = d3.scaleBand()
				.rangeRound([0, height])	// .rangeRound([0, width])
				.paddingInner(0.05)
				.align(0.1);

			var x = d3.scaleLinear()		// y = d3.scaleLinear()
				.rangeRound([0, width]);	// .rangeRound([height, 0]);

			var z = d3.scaleOrdinal(d3.schemeCategory10);



			  //console.log(d3.max(data, function(d) { return d.free; }));

			  data.sort(function(a, b) { return b.total - a.total; });
			  y.domain(data.map(function(d) { return d.name; }));					// x.domain...
			  x.domain([0, d3.max(data, function(d) { return d.total; })]).nice();	// y.domain...
			  z.domain(keys);

			  svg.append("g")
				.selectAll("g")
				.data(d3.stack().keys(keys)(data))
				.enter().append("g")
				  .attr("fill", function(d) { return z(d.key); })
				.selectAll("rect")
				.data(function(d) { return d; })
				.enter().append("rect")
				  .attr("y", function(d) { return y(d.data.name); })	    //.attr("x", function(d) { return x(d.data.name); })
				  .attr("x", function(d) { return x(d[0]); })			    //.attr("y", function(d) { return y(d[1]); })
				  .attr("width", function(d) { return x(d[1]) - x(d[0]); })	//.attr("height", function(d) { return y(d[0]) - y(d[1]); })
				  .attr("height", y.bandwidth())						    //.attr("width", x.bandwidth());
				.on('mouseover', function(d){
					  d3.select(this).attr('opacity', 0.7);
					  tooltip.transition().duration(100).style('opacity', 0.95);
					  tooltip.html(
							'<div style="font-size: 1rem; color: #0b3536; font-weight: bold">technology: ' + d.data.name + '<br> total: ' + d.data.total + '<br> doing:' + d.data.doing + '<br> unpaid:' + d.data.unpaid + '<br> free:'+d.data.free +'</div>')
						.style('left', (x(d[0])+ (x(d[1]) - x(d[0]))/2) + 'px')
						.style('top', (y(d.data.name) + y.bandwidth()/10) + 'px');
					  })
					.on('mouseout', function(d){
					  d3.select(this)
						.attr('opacity', 1);
					  tooltip.transition().style('opacity', 0); });

			  svg.append("g")
				  .attr("class", "axis")
				  .attr("transform", "translate(0,0)") 						//  .attr("transform", "translate(0," + height + ")")
				  .call(d3.axisLeft(y));									//   .call(d3.axisBottom(x));

			  svg.append("g")
				  .attr("class", "axis")
				  .attr("transform", "translate(0,"+height+")")				// New line
				  .call(d3.axisBottom(x).ticks(null, "s"))					//  .call(d3.axisLeft(y).ticks(null, "s"))
				.append("text")
				  .attr("y", 2)												//     .attr("y", 2)
				  .attr("x", x(x.ticks().pop()) + 0.5) 						//     .attr("y", y(y.ticks().pop()) + 0.5)
				  .attr("dy", "0.32em")										//     .attr("dy", "0.32em")
				  .attr("fill", "#000")
				  .attr("font-weight", "bold")
				  .attr("text-anchor", "start")
				  .text("Population")
				  .attr("transform", "translate("+ (-width) +",-10)");   	// Newline

			  var legend = svg.append("g")
				  .attr("font-family", "sans-serif")
				  .attr("font-size", 10)
				  .attr("text-anchor", "end")
				.selectAll("g")
				.data(keys.slice().reverse())
				.enter().append("g")
				//.attr("transform", function(d, i) { return "translate(0," + i * 20 + ")"; });
				 .attr("transform", function(d, i) { return "translate(-50," + (300 + i * 20) + ")"; });

			  legend.append("rect")
				  .attr("x", width - 19)
				  .attr("width", 19)
				  .attr("height", 19)
				  .attr("fill", z);

			  legend.append("text")
				  .attr("x", width - 24)
				  .attr("y", 9.5)
				  .attr("dy", "0.32em")
				  .text(function(d) { return d; });
		}

		//drawHorizonBarChart(data,chartid);
		get_freerate_query();
		function get_freerate_query(){
			var data = {};
			var url='__URL__/getTechWorkerDatas';
			$.ajax({
				type:"get",
				url:url,
				success: function aa(data) {
					//showstorelist(data.stores);
					//console.log(data);
					//var para = {mindate:fstep ,maxdate:tstep,xtformate:xtformate,xnum:xnum,ytext:"Total Profit"};
					//drawLineChart(data,"#chart","profit",para);
					//drwaStackBar(data,"#stackedbar",["free","doing","unpaid"]);
					drawHorizonBarChart(data,"#horizonbar")

				}
			});
		}
	function drawHorizonBarChart(data,chartid){


		$(chartid).html("");
		var wd = $(chartid).width();
		var wh = $(chartid).height();
		var margin = {top:20, left:120, bottom:20, right:20};
		var height = wh - margin.top - margin.bottom,
			width = wd - margin.left - margin.right;
		var svg = d3.select(chartid).append("svg")
					  .attr("width", (width + margin.left + margin.right)+"px")
					  .attr("height", (height+margin.top + margin.bottom)+"px")
					  .append('g')
					  .attr("transform", `translate(${margin.left}, ${margin.right})`);
		var tooltip = d3.select(chartid).append('div')
			.attr('class', 'tooltip').style('opacity', 0);

		// set the ranges
		var y = d3.scaleBand()
				  .range([height, 0])
				  .padding(0.1);

		var x = d3.scaleLinear()
				  .range([0, width]);

		// append the svg object to the body of the page
		// append a 'group' element to 'svg'
		// moves the 'group' element to the top left margin
		  // format the data
		  data.forEach(function(d) {
			d.rate = +d.rate;
		  });

		  // Scale the range of the data in the domains
		  x.domain([0, d3.max(data, function(d){ return d.rate; })])
		  y.domain(data.map(function(d) { return d.name; }));
		  //y.domain([0, d3.max(data, function(d) { return d.rate; })]);

		  // append the rectangles for the bar chart
		  svg.selectAll(".bar")
			  .data(data)
			.enter().append("rect")
			  .attr("class", "bar")
				.attr("fill", "red")
			  //.attr("x", function(d) { return x(d.rate); })
			  .attr("width", function(d) {return x(d.rate); } )
			  .attr("y", function(d) { return y(d.name); })
			  .attr("height", y.bandwidth())
			.on('mouseover', function(d){
				  d3.select(this).attr('opacity', 0.7);
				  tooltip.transition().duration(100).style('opacity', 0.95);
					tooltip.html(
						'<div style="font-size: 1rem; color: #0b3536; font-weight: bold">' +
						d.name+ '<br/>technology: ' + d.name + '<br/> total: ' + d.total + '<br/> free:' + d.free + '<br/> unpaid:' + d.unpaid + '<br/> rate:'+d.rate +'</div>')
					.style('left', (x(d.rate))/2 + 'px')
					.style('top', (y(d.name) + y.bandwidth()/2) + 'px');
				  })
				.on('mouseout', function(d){
				  d3.select(this)
					.attr('opacity', 1);
				  tooltip.transition().style('opacity', 0); });

		  // add the x Axis
		  svg.append("g")
			  .attr("transform", "translate(0," + height + ")")
			  .call(d3.axisBottom(x));

		  // add the y Axis
		  svg.append("g")
			  .call(d3.axisLeft(y));
	}
	var dataset = {:json_encode($workerpiedata)};
	//console.log(dataset);
	drawPieChart(dataset,"#totalpiechart");
	function drawPieChart(dataset,chartid){


		var donutWidth = 20;
		var width = $(chartid).width();
		var height = $(chartid).height();
		var radius = Math.min(width, height) / 2;
		var legendRectSize = 18;
		var legendSpacing = 4;

		var color = d3.scaleOrdinal(d3.schemeCategory20);
		var tooltip = d3.select(chartid)
		  .append('div')
		  .attr('class', 'tooltip');

		var svg = d3.select(chartid)
			.append('svg')
			.attr('width', width)
			.attr('height', height)
			.append('g')
			.attr('transform', 'translate(' + (width / 2) +  ',' + (height / 2) + ')');

		var arc = d3.arc()
			.innerRadius(radius - donutWidth)
			.outerRadius(radius);

		var pie = d3.pie()
			.value(function(d) { return d.count; })
			.sort(null);


		var path = svg.selectAll('path')
			.data(pie(dataset))
			.enter()
			.append('path')
			.attr('d', arc)
			.attr('fill', function(d, i) {
				return color(d.data.label);
			});
		path.on('mouseover', function(d) {
		  var total = d3.sum(dataset.map(function(d) {
			return d.count;
		  }));
		  var percent = Math.round(1000 * d.data.count / total) / 10;
		  tooltip.html(d.data.label + "<br>"+ d.data.count + "<br>" + percent + "%");
		  tooltip.style('display', 'block')
			.style('top', (height/2 ) + 'px')
			.style('left', (width/2 - 30) + 'px')
			.style('opacity', 0.9);
		});

		path.on('mouseout', function() {
		  tooltip.style('display', 'none');
		});

		var legend = svg.selectAll('.legend')
		  .data(color.domain())
		  .enter()
		  .append('g')
		  .attr('class', 'legend')
		  .attr('transform', function(d, i) {
			var height = legendRectSize + legendSpacing;
			var offset =  height * color.domain().length / 2;
			var horz = -2 * legendRectSize;
			var vert = i * height - offset;
			return 'translate(' + horz + ',' + vert + ')';
		  });

		legend.append('rect')
			.attr('width', legendRectSize)
			.attr('height', legendRectSize)
			.style('fill', color)
			.style('stroke', color);

		legend.append('text')
			.attr('x', legendRectSize + legendSpacing)
			.attr('y', legendRectSize - legendSpacing)
			.text(function(d) { return d; });
	}

</script>
</block>
